trigger:
  branches:
    include:
    - master
  paths:
    exclude:
    - pipelines/*
    - deploy/*

variables:
    dockerid:   'bjd145'
    imageName:  'bjd145/whatos'
    blueWeight: 0
    blueReplicas: 0
    greenWeight: 0
    greenReplicas: 0

stages:
- stage: builds
  jobs: 
  - job: 'Build_And_Push'
    pool:
      vmImage: 'Ubuntu 16.04'
    steps:

    - task: CopyFiles@2
      inputs:
        SourceFolder: deploy
        TargetFolder: '$(build.artifactstagingdirectory)'
      displayName: Copy Artifacts  

    - task: PublishBuildArtifacts@1
      displayName: Publish Build Artifacts 

- stage: deploy_10_percent
  jobs:
  - deployment: 'Deploy_To_AKS'
    pool:
      vmImage: 'Ubuntu 16.04'
    environment: 'AKS.whatosapi'
    strategy:
      canary:
        increments: [10,50,90]  
        deploy:
          steps:
          - task: DownloadPipelineArtifact@2
            inputs:
              buildType: 'current'
              targetPath: '$(System.DefaultWorkingDirectory)/'
              
          - task: PowerShell@2
            displayName: "Display Values"
            inputs:
              targetType: 'inline'
              script: |
                Write-Host ("Blue Weight: {0}" -f $(blueWeight) )
                Write-Host ("Green Weight: {0}" -f $(greenWeight) )

          - task: PowerShell@2
            displayName: "Set Values"
            inputs:
              targetType: 'inline'
              script: |
                $pods = @{ "0" = 0; "10" = 1; "50" = 2; "90" = 3; "100" = 4 }

                $blue  = $(strategy.increment)
                $green = 100 - $(strategy.increment)

                $blueReplicas = $pods[[convert]::ToString($blue)]
                $greenReplicas = $pods[[convert]::ToString($green)]

                $blueWeight = "{0}%" -f $blue
                $greenWeight = "{0}%" -f $green

                Write-Host "##vso[task.setvariable variable=blueWeight]$blueWeight"
                Write-Host "##vso[task.setvariable variable=greenWeight]$greenWeight"
                Write-Host "##vso[task.setvariable variable=blueReplicas]$blueReplicas"
                Write-Host "##vso[task.setvariable variable=greenReplicas]$greenReplicas"


          - task: PowerShell@2
            displayName: "Display Values"
            inputs:
              targetType: 'inline'
              script: |
                Write-Host "Blue Weight: $(blueWeight)" 
                Write-Host "Green Weight: $(greenWeight)"
                Write-Host "Blue Replicas: $(blueReplicas)" 
                Write-Host "Green Replicas: $(greenReplicas)"
                


